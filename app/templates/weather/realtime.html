{% extends "base.html" %}

{% block title %}气象实况数据查询{% endblock %}

{% block css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/ol.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/datetimepicker.min.css') }}">
<style>
    .container { margin-top: 20px; }
    #map { height: 500px; width: 100%; }
    .time-axis { margin: 10px 0; padding: 10px; border: 1px solid #ddd; }
    .option-area { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
    .table-area { max-height: 300px; overflow-y: auto; }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- 选项区域（2号区域） -->
    <div class="option-area">
        <div class="row">
            <div class="col-md-4">
                <label for="area-select">地区：</label>
                <select id="area-select" class="form-select">
                    {% for area in areas %}
                    <option value="{{ area.areacode }}" {% if area.areaname == '成都' %}selected{% endif %}>
                        {{ area.areaname }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <label for="time-select">时间：</label>
                <input type="text" id="time-select" class="form-control" value="{{ current_time }}">
            </div>
            <div class="col-md-4">
                <label>要素：</label>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="temp" value="temp" checked>
                    <label class="form-check-label" for="temp">气温</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="rain" value="rain" checked>
                    <label class="form-check-label" for="rain">降水</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="rh" value="rh" checked>
                    <label class="form-check-label" for="rh">湿度</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="press" value="press" checked>
                    <label class="form-check-label" for="press">气压</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="wind" value="wind" checked>
                    <label class="form-check-label" for="wind">风</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="vis" value="vis" checked>
                    <label class="form-check-label" for="vis">能见度</label>
                </div>
            </div>
        </div>
    </div>

    <!-- 地图区域（1号区域） -->
    <div id="map"></div>
    <!-- 时间轴 -->
    <div class="time-axis" id="time-axis">
        <button class="btn btn-sm btn-outline-primary" id="prev-hour">← 上一小时</button>
        <span id="current-time-display">{{ current_time }}</span>
        <button class="btn btn-sm btn-outline-primary" id="next-hour">下一小时 →</button>
    </div>

    <!-- 表格数据区域（3号区域） -->
    <div class="table-area">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>站点编码</th>
                    <th>站点名称</th>
                    <th>气温(℃)</th>
                    <th>降水(mm)</th>
                    <th>湿度(%)</th>
                    <th>气压(hPa)</th>
                    <th>风速(m/s)</th>
                    <th>风向(°)</th>
                    <th>能见度(km)</th>
                </tr>
            </thead>
            <tbody id="obs-table-body"></tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block js %}
<script src="{{ url_for('static', filename='js/jquery.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/ol.js') }}"></script>
<script src="{{ url_for('static', filename='js/datetimepicker.min.js') }}"></script>
<script>
    // 初始化时间选择器
    $('#time-select').datetimepicker({
        format: 'Y-m-d H:i',
        step: 60,
        minutesStep: 60,
        timepicker: true,
        datepicker: true,
        defaultTime: '{{ current_time.split(" ")[1] }}'
    });

    // 初始化地图
    const map = new ol.Map({
        target: 'map',
        layers: [
            new ol.layer.Tile({
                source: new ol.source.XYZ({
                    url: '{{ map_service_url }}/{z}/{x}/{y}.png'
                })
            })
        ],
        view: new ol.View({
            center: ol.proj.fromLonLat([104.065735, 30.659462]), // 成都中心点
            zoom: 8
        })
    });

    // 地区边界层
    let boundaryLayer = new ol.layer.Vector({
        source: new ol.source.Vector(),
        style: new ol.style.Style({
            stroke: new ol.style.Stroke({ color: '#ff0000', width: 2 }),
            fill: new ol.style.Fill({ color: 'rgba(255, 0, 0, 0.1)' })
        })
    });
    map.addLayer(boundaryLayer);

    // 站点数据层（所有要素共用）
    let stationLayer = new ol.layer.Vector({
        source: new ol.source.Vector(),
        style: function(feature) {
            const data = feature.get('data') || {};
            return new ol.style.Style({
                image: new ol.style.Circle({
                    radius: 6,
                    fill: new ol.style.Fill({ color: '#0066cc' }),
                    stroke: new ol.style.Stroke({ color: '#fff', width: 1 })
                }),
                text: new ol.style.Text({
                    text: feature.get('staname'),
                    offsetY: 15,
                    font: '12px sans-serif',
                    fill: new ol.style.Fill({ color: '#333' })
                })
            });
        }
    });
    map.addLayer(stationLayer);

    // 加载地区边界
    function loadAreaBoundary(areaName) {
        $.get('/weather/api/get_area_boundary', { area_name: areaName }, function(geometry) {
            const format = new ol.format.GeoJSON();
            const features = format.readFeatures({
                type: 'Feature',
                geometry: geometry
            });
            boundaryLayer.setSource(new ol.source.Vector({ features: features }));
            // 自适应地图范围
            const extent = boundaryLayer.getSource().getExtent();
            map.getView().fit(extent, { padding: [50, 50, 50, 50] });
        });
    }

    // 加载实况数据
    function loadObsData() {
        const areaCode = $('#area-select').val();
        const obsTime = $('#time-select').val();
        const elements = [];
        $('.form-check-input:checked').each(function() {
            elements.push($(this).val());
        });

        $.get('/weather/api/get_obs_data', {
            area_code: areaCode,
            obs_time: obsTime,
            elements: elements
        }, function(data) {
            // 更新站点图层
            const features = data.map(item => {
                const point = new ol.geom.Point(ol.proj.fromLonLat([item.lon, item.lat]));
                return new ol.Feature({
                    geometry: point,
                    sta: item.sta,
                    staname: item.staname,
                    data: item.data
                });
            });
            stationLayer.setSource(new ol.source.Vector({ features: features }));

            // 更新表格数据
            const tableBody = $('#obs-table-body');
            tableBody.empty();
            data.forEach(item => {
                const row = `<tr>
                    <td>${item.sta}</td>
                    <td>${item.staname}</td>
                    <td>${item.data.temp || '-'}</td>
                    <td>${item.data.rain || '-'}</td>
                    <td>${item.data.rh || '-'}</td>
                    <td>${item.data.press || '-'}</td>
                    <td>${item.data.wspeed || '-'}</td>
                    <td>${item.data.wdirection || '-'}</td>
                    <td>${item.data.vis || '-'}</td>
                </tr>`;
                tableBody.append(row);
            });

            // 更新时间轴显示
            $('#current-time-display').text(obsTime);
        });
    }

    // 事件绑定
    $('#area-select').change(function() {
        const areaName = $(this).find('option:selected').text();
        loadAreaBoundary(areaName);
        loadObsData();
    });

    $('#time-select').change(loadObsData);

    $('.form-check-input').change(loadObsData);

    $('#prev-hour, #next-hour').click(function() {
        const currentTime = new Date($('#time-select').val());
        if ($(this).attr('id') === 'prev-hour') {
            currentTime.setHours(currentTime.getHours() - 1);
        } else {
            currentTime.setHours(currentTime.getHours() + 1);
        }
        const newTime = `${currentTime.getFullYear()}-${(currentTime.getMonth()+1).toString().padStart(2, '0')}-${currentTime.getDate().toString().padStart(2, '0')} ${currentTime.getHours().toString().padStart(2, '0')}:00`;
        $('#time-select').val(newTime);
        loadObsData();
    });

    // 初始化加载
    $(document).ready(function() {
        loadAreaBoundary('成都');
        loadObsData();
    });
</script>
{% endblock %}